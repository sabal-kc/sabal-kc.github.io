<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Exploring a solution for a limitation of RSA encryption | Sabal K.C.</title> <meta name="author" content="Sabal K.C."> <meta name="description" content="A simple, whitespace theme for academics. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://sabal-kc.github.io/blog/2023/encryption/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Sabal </span>K.C.</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Exploring a solution for a limitation of RSA encryption</h1> <p class="post-meta">June 1, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/golang"> <i class="fas fa-hashtag fa-sm"></i> golang</a>   <a href="/blog/tag/encryption"> <i class="fas fa-hashtag fa-sm"></i> encryption</a>     ·   <a href="/blog/category/programming"> <i class="fas fa-tag fa-sm"></i> programming</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>RSA algorithm is an asymmetric cryptography algorithm that consists of two different keys i.e. Public Key and Private Key. It is one of the most widely used encryption methods to securely transmit information. But it does have some limitations. In this article, I will aim to explain a solution to a problem that arose when trying to encrypt a response payload with this algorithm in golang.</p> <p>To encrypt a response payload with a public key, the approach is to use the EncryptOAEP method from the “crypto/rsa” package. It is an Optimal Asymmetric Encryption Padding (OAEP) algorithm that takes in a random hash as the first parameter (sha256 hash is passed here). The second parameter consists of a random parameter to ensure entropy. Following these two parameters are the public key and the payload (bytes) that is to be encrypted. The final parameter is a label parameter (which does not get encrypted), this is passed as nil.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rsa</span><span class="o">.</span><span class="n">EncryptOAEP</span><span class="p">(</span><span class="n">sha256</span><span class="o">.</span><span class="n">New</span><span class="p">(),</span> <span class="n">rand</span><span class="o">.</span><span class="n">Reader</span><span class="p">,</span> <span class="n">publicKey</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
</code></pre></div></div> <p>This is a sound working approach. However, a limitation is that the message must be no longer than the length of the RSA modulus minus twice the hash length, minus a further 2. Although it works perfectly fine for normal length messages, some payloads exceeded this limit and an error gets thrown: RS256 message too long for RSA public key size.</p> <p>The two common solutions to this problem are:</p> <ol> <li> <p>Hybrid Encryption: In hybrid encryption, a combination of symmetric and asymmetric encryption is used. RSA is used to securely exchange a symmetric encryption key, which is then used to encrypt the actual message. This approach is commonly used in protocols like SSL/TLS for secure communication over the internet.</p> </li> <li> <p>Chunking: Instead of encrypting the entire message as one block, the message is divided into smaller chunks or blocks. Each block is individually encrypted. The encryption is pretty straightforward, where we encrypt m bytes at a time as shown below:</p> </li> </ol> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h</span> <span class="o">:=</span> <span class="n">sha256</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
<span class="n">m</span> <span class="o">:=</span> <span class="n">maxPayloadSize</span><span class="p">(</span><span class="n">publicKey</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
    <span class="c">// For the last chunk, go upto the length</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// Encrypt m bytes at a time</span>
    <span class="n">encChunk</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">EncryptOAEP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">rand</span><span class="o">.</span><span class="n">Reader</span><span class="p">,</span> <span class="n">publicKey</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="o">:</span><span class="n">m</span><span class="p">],</span> <span class="no">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="c">// Write to some output buffer</span>
    <span class="n">encBytes</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">encChunk</span><span class="p">)</span>

    <span class="c">// Move forward</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">m</span><span class="o">:</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div> <p>Here, the max payload size is given by:</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">maxPayloadSize</span><span class="p">(</span><span class="n">key</span> <span class="o">*</span><span class="n">rsa</span><span class="o">.</span><span class="n">PublicKey</span><span class="p">,</span> <span class="n">hash</span> <span class="n">hash</span><span class="o">.</span><span class="n">Hash</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">-</span> <span class="m">2</span><span class="o">*</span><span class="n">hash</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">-</span> <span class="m">2</span>
<span class="p">}</span>
</code></pre></div></div> <p>However, for decryption, the chunks must be traversed at a gap of the public key’s length to get the correct result, not the max payload size, since the encrypted result would be of a different size in comparison to the original payload.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h</span> <span class="o">:=</span> <span class="n">sha256</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
<span class="n">m</span> <span class="o">:=</span> <span class="n">privateKey</span><span class="o">.</span><span class="n">PublicKey</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span>

<span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="n">encBytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
    <span class="c">// For the last chunk, go upto the length</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">encBytes</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encBytes</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// Encrypt m bytes at a time</span>
    <span class="n">decChunk</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">DecryptOAEP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="n">privateKey</span><span class="p">,</span> <span class="n">encBytes</span><span class="p">[</span><span class="o">:</span><span class="n">m</span><span class="p">],</span> <span class="no">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="c">// Write to some output buffer</span>
    <span class="n">decBytes</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">decChunk</span><span class="p">)</span>

    <span class="c">// Move forward</span>
    <span class="n">encBytes</span> <span class="o">=</span> <span class="n">encBytes</span><span class="p">[</span><span class="n">m</span><span class="o">:</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Sabal K.C.. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>